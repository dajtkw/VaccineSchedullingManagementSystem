@model QuanLyTiemChung.Web.ViewModels.CreateAppointmentViewModel
@{
    ViewData["Title"] = "Đăng ký tiêm chủng";
}

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="text-center mb-4">
                <h2>@ViewData["Title"]</h2>
                <p class="text-muted">Tìm kiếm điểm tiêm hoặc lọc theo khu vực để xem vắc-xin hiện có.</p>
            </div>

            <div class="card shadow-sm">
                <div class="card-body p-4 p-md-5">
                    <form asp-action="Create" method="post">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                        <h5 class="mb-3 border-bottom pb-2">1. Chọn địa điểm và thời gian</h5>

                        @* --- Address Filters --- *@
                        <div class="row mb-3">
                            <div class="col-12">
                                <a class="text-primary text-decoration-none" data-bs-toggle="collapse"
                                   href="#filterCollapse" role="button" aria-expanded="false"
                                   aria-controls="filterCollapse">
                                    <i class="fas fa-filter me-1"></i> Lọc chi tiết theo Tỉnh/Huyện/Xã
                                </a>
                            </div>
                        </div>
                        <div class="collapse" id="filterCollapse">
                            <div class="row p-3 mb-3 bg-light rounded border">
                                <div class="col-md-4 mb-2">
                                    <label class="form-label small">Tỉnh/Thành phố</label>
                                    <select id="provinceSelect" class="form-select form-select-sm">
                                        <option value="">-- Tất cả --</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <label class="form-label small">Quận/Huyện</label>
                                    <select id="districtSelect" class="form-select form-select-sm" disabled>
                                        <option value="">-- Tất cả --</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <label class="form-label small">Phường/Xã</label>
                                    <select id="wardSelect" class="form-select form-select-sm" disabled>
                                        <option value="">-- Tất cả --</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        @* --- Main Selections --- *@
                        <div class="row mb-4">
                            <div class="col-md-12 mb-3">
                                <label asp-for="SelectedSiteId" class="form-label">Điểm tiêm chủng</label>
                                <select asp-for="SelectedSiteId" class="form-select">
                                    <option value="">-- Vui lòng chọn --</option>
                                </select>
                                <span asp-validation-for="SelectedSiteId" class="text-danger"></span>
                            </div>
                            <div class="col-md-12">
                                <label asp-for="ScheduledDateTime" class="form-label">Chọn ngày giờ hẹn</label>
                                <input asp-for="ScheduledDateTime" class="form-control" type="datetime-local" />
                                <span asp-validation-for="ScheduledDateTime" class="text-danger"></span>
                            </div>
                        </div>

                        <h5 class="mb-3 border-bottom pb-2">2. Chọn vắc-xin</h5>

                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="categoryFilterSelect" class="form-label">Lọc theo danh mục vắc-xin (không
                                    bắt buộc)</label>
                                <select id="categoryFilterSelect" class="form-select" disabled>
                                    <option value="0">-- Hiển thị tất cả danh mục --</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-8">
                                <label asp-for="SelectedVaccineId" class="form-label">Loại vắc-xin</label>
                                <select asp-for="SelectedVaccineId" class="form-select" disabled>
                                    <option value="">-- Chọn điểm tiêm trước --</option>
                                </select>
                                <span asp-validation-for="SelectedVaccineId" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="DoseNumber" class="form-label">Mũi tiêm thứ</label>
                                <input asp-for="DoseNumber" class="form-control" type="number" min="1"
                                    placeholder="Ví dụ: 1" />
                                <span asp-validation-for="DoseNumber" class="text-danger"></span>
                            </div>
                        </div>

                        <h5 class="mb-3 border-bottom pb-2">3. Ghi chú</h5>
                        <div class="mb-4">
                            <label asp-for="Notes" class="form-label">Ghi chú thêm (nếu có)</label>
                            <textarea asp-for="Notes" class="form-control" rows="3"
                                placeholder="Thông tin về tình trạng sức khỏe, dị ứng hoặc yêu cầu đặc biệt..."></textarea>
                        </div>

                        <div class="d-grid gap-2 pt-3">
                            <button type="submit" class="btn btn-primary btn-lg">Xác nhận Đăng ký</button>
                            <a asp-action="Index" class="btn btn-outline-secondary">Quay lại danh sách</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        $(document).ready(function () {
            // --- Khai báo các đối tượng jQuery ---
            const provinceSelect = $('#provinceSelect');
            const districtSelect = $('#districtSelect');
            const wardSelect = $('#wardSelect');
            const siteSelect = $('#SelectedSiteId');
            const vaccineSelect = $('#SelectedVaccineId');
            const categoryFilterSelect = $('#categoryFilterSelect');

            // --- Khởi tạo Select2 ---
            siteSelect.select2({
                theme: 'bootstrap-5',
                placeholder: 'Tìm hoặc chọn một điểm tiêm chủng',
            });

            // --- Các hàm tiện ích ---
            function resetDropdown(dropdown, defaultText, isDisabled = true) {
                dropdown.empty().append(`<option value="">${defaultText}</option>`).prop('disabled', isDisabled);
                if (dropdown.is(siteSelect) || dropdown.is(vaccineSelect)) {
                    dropdown.trigger('change');
                }
            }

            // --- Các hàm tải dữ liệu (AJAX) ---
            function populateSites(province, district, ward) {
                resetDropdown(siteSelect, 'Đang tải điểm tiêm...');
                $.getJSON('/Appointment/GetSites', { provinceName: province, districtName: district, wardName: ward })
                    .done(function (data) {
                        resetDropdown(siteSelect, '-- Vui lòng chọn --', !(data && data.length > 0));
                        $.each(data, function (index, item) {
                            siteSelect.append(new Option(item.text, item.value));
                        });
                        siteSelect.trigger('change');
                    })
                    .fail(function() {
                        resetDropdown(siteSelect, 'Lỗi tải điểm tiêm');
                    });
            }

            function loadCategories() {
                resetDropdown(categoryFilterSelect, 'Đang tải danh mục...', true);
                $.getJSON('/Appointment/GetCategoriesJson')
                    .done(function (categories) {
                        categoryFilterSelect.empty().append('<option value="0">-- Hiển thị tất cả --</option>');
                        if (categories && categories.length > 0) {
                            $.each(categories, function (i, cat) {
                                categoryFilterSelect.append(new Option(cat.name, cat.id));
                            });
                            categoryFilterSelect.prop('disabled', false);
                        }
                    });
            }

            function loadVaccines() {
                const siteId = siteSelect.val();
                const categoryId = categoryFilterSelect.val();
                
                if (!siteId) {
                    resetDropdown(vaccineSelect, '-- Chọn điểm tiêm trước --');
                    return;
                }

                resetDropdown(vaccineSelect, 'Đang tải vắc-xin...');
                $.getJSON('/Appointment/GetAvailableVaccines', { siteId: siteId, categoryId: categoryId })
                    .done(function (groupedData) {
                        if (groupedData && groupedData.length > 0) {
                            resetDropdown(vaccineSelect, '-- Vui lòng chọn vắc-xin --', false);
                            $.each(groupedData, function (index, group) {
                                const optgroup = $(`<optgroup label="${group.groupName}"></optgroup>`);
                                $.each(group.vaccines, function (i, vaccine) {
                                     let displayText = vaccine.text;
                                     if (vaccine.isScheduledDose) {
                                         displayText += " (Theo liệu trình)";
                                     }
                                    optgroup.append(new Option(displayText, vaccine.value));
                                });
                                vaccineSelect.append(optgroup);
                            });
                        } else {
                            resetDropdown(vaccineSelect, 'Không có vắc-xin phù hợp');
                        }
                        vaccineSelect.trigger('change');
                    })
                    .fail(function() {
                        resetDropdown(vaccineSelect, 'Lỗi tải vắc-xin');
                    });
            }

            // --- Gắn các sự kiện ---
            siteSelect.on('change', loadVaccines);
            categoryFilterSelect.on('change', loadVaccines);

            provinceSelect.on('change', function () {
                const provinceName = $(this).val();
                resetDropdown(districtSelect, '-- Vui lòng chọn --', !provinceName);
                resetDropdown(wardSelect, '-- Chọn Quận/Huyện trước --');
                populateSites(provinceName, '', '');

                if (provinceName) {
                    $.getJSON(`/Appointment/GetDistricts`, { provinceName: provinceName }, function (data) {
                        $.each(data, function (index, item) {
                            districtSelect.append(new Option(item, item));
                        });
                    });
                }
            });

            districtSelect.on('change', function () {
                const provinceName = provinceSelect.val();
                const districtName = $(this).val();
                resetDropdown(wardSelect, '-- Vui lòng chọn --', !districtName);
                populateSites(provinceName, districtName, '');

                if (districtName) {
                    $.getJSON(`/Appointment/GetWards`, { provinceName: provinceName, districtName: districtName }, function (data) {
                        $.each(data, function (index, item) {
                            wardSelect.append(new Option(item, item));
                        });
                    });
                }
            });

            wardSelect.on('change', function () {
                const provinceName = provinceSelect.val();
                const districtName = districtSelect.val();
                const wardName = $(this).val();
                populateSites(provinceName, districtName, wardName);
            });

            // --- Tải dữ liệu ban đầu ---
            function initialLoad() {
                populateSites('', '', '');
                loadCategories();
                
                $.getJSON('/Appointment/GetProvinces').done(function (data) {
                    resetDropdown(provinceSelect, '-- Tất cả --', false);
                    $.each(data, function (index, item) {
                        provinceSelect.append(new Option(item.text, item.value));
                    });
                });
            }

            initialLoad();
        });
    </script>
}