@model QuanLyTiemChung.Web.Models.Vaccine

<form id="editVaccineForm" data-url="/Admin/EditVaccineApi">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="Id" />
    
    <div id="validation-summary" class="alert alert-danger" style="display: none;"></div>

    <ul class="nav nav-tabs" id="vaccineTabEdit" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="info-tab-edit" data-bs-toggle="tab" data-bs-target="#info-edit" type="button" role="tab" aria-controls="info-edit" aria-selected="true">Thông tin chung</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="doses-tab-edit" data-bs-toggle="tab" data-bs-target="#doses-edit" type="button" role="tab" aria-controls="doses-edit" aria-selected="false">Quản lý liều</button>
        </li>
    </ul>

    <div class="tab-content" id="vaccineTabContentEdit">
        <div class="tab-pane fade show active" id="info-edit" role="tabpanel" aria-labelledby="info-tab-edit">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label asp-for="TradeName" class="form-label">
                        Tên thương mại <span class="text-danger">*</span>
                    </label>
                    <input asp-for="TradeName" class="form-control" required />
                    <div asp-validation-for="TradeName" class="invalid-feedback"></div>
                </div>
                <div class="col-md-6 mb-3">
                    <label asp-for="GenericName" class="form-label">
                        Tên chung <span class="text-danger">*</span>
                    </label>
                    <input asp-for="GenericName" class="form-control" required />
                    <div asp-validation-for="GenericName" class="invalid-feedback"></div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label asp-for="VaccineCategoryId" class="form-label">
                        Danh mục <span class="text-danger">*</span>
                    </label>
                    <select asp-for="VaccineCategoryId" class="form-select" required>
                        <option value="">-- Chọn danh mục --</option>
                        @if (ViewBag.Categories != null)
                        {
                            @foreach (var category in (IEnumerable<QuanLyTiemChung.Web.Models.VaccineCategory>)ViewBag.Categories)
                            {
                                <option value="@category.Id" selected="@(category.Id == Model.VaccineCategoryId)">@category.Name</option>
                            }
                        }
                    </select>
                    <div asp-validation-for="VaccineCategoryId" class="invalid-feedback"></div>
                </div>
                <div class="col-md-6 mb-3">
                    <label asp-for="Manufacturer" class="form-label">
                        Nhà sản xuất
                    </label>
                    <input asp-for="Manufacturer" class="form-control" />
                    <div asp-validation-for="Manufacturer" class="invalid-feedback"></div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label asp-for="CountryOfOrigin" class="form-label">
                        Xuất xứ
                    </label>
                    <input asp-for="CountryOfOrigin" class="form-control" />
                    <div asp-validation-for="CountryOfOrigin" class="invalid-feedback"></div>
                </div>
                <div class="col-md-6 mb-3">
                    <label asp-for="Price" class="form-label">
                        Giá (VNĐ)
                    </label>
                    <input asp-for="Price" type="number" min="0" step="1000" class="form-control" placeholder="Để trống nếu miễn phí" />
                    <div asp-validation-for="Price" class="invalid-feedback"></div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label asp-for="MinAge" class="form-label">
                        Độ tuổi tối thiểu (năm)
                    </label>
                    <input asp-for="MinAge" type="number" min="0" class="form-control" placeholder="Để trống nếu không giới hạn" />
                    <div asp-validation-for="MinAge" class="invalid-feedback"></div>
                </div>
                <div class="col-md-6 mb-3">
                    <label asp-for="MaxAge" class="form-label">
                        Độ tuổi tối đa (năm)
                    </label>
                    <input asp-for="MaxAge" type="number" min="0" class="form-control" placeholder="Để trống nếu không giới hạn" />
                    <div asp-validation-for="MaxAge" class="invalid-feedback"></div>
                </div>
            </div>

            <div class="mb-3">
                <label asp-for="Description" class="form-label">
                    Mô tả chi tiết
                </label>
                <textarea asp-for="Description" class="form-control" rows="3" placeholder="Mô tả tác dụng, lưu ý sử dụng..."></textarea>
                <div asp-validation-for="Description" class="invalid-feedback"></div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label asp-for="Indications" class="form-label">
                        Chỉ định sử dụng
                    </label>
                    <textarea asp-for="Indications" class="form-control" rows="2" placeholder="Phòng chống các bệnh..."></textarea>
                    <div asp-validation-for="Indications" class="invalid-feedback"></div>
                </div>
                <div class="col-md-6 mb-3">
                    <label asp-for="Contraindications" class="form-label">
                        Chống chỉ định
                    </label>
                    <textarea asp-for="Contraindications" class="form-control" rows="2" placeholder="Không sử dụng trong trường hợp..."></textarea>
                    <div asp-validation-for="Contraindications" class="invalid-feedback"></div>
                </div>
            </div>

            <div class="mb-3 form-check">
                <input asp-for="IsActive" type="checkbox" class="form-check-input" />
                <label asp-for="IsActive" class="form-check-label">
                    Đang sử dụng
                </label>
            </div>
        </div>
        
        <div class="tab-pane fade" id="doses-edit" role="tabpanel" aria-labelledby="doses-tab-edit">
            <div id="doses-container-edit">
                @if (Model.Doses != null && Model.Doses.Any())
                {
                    @for (int i = 0; i < Model.Doses.Count; i++)
                    {
                        var dose = Model.Doses.ElementAt(i);
                        <div class="dose-item border rounded p-3 mb-3">
                            <input type="hidden" name="Doses.Index" value="@i" />
                            <input type="hidden" name="Doses[@i].Id" value="@dose.Id" />
                            <input type="hidden" name="Doses[@i].VaccineId" value="@dose.VaccineId" />
                            <div class="row">
                                <div class="col-md-2">
                                    <label class="form-label">Mũi số</label>
                                    <input name="Doses[@i].DoseNumber" value="@dose.DoseNumber" type="number" class="form-control" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Tuổi khuyến nghị</label>
                                    <input name="Doses[@i].RecommendedAge" value="@dose.RecommendedAge" type="text" class="form-control" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Khoảng cách (tháng)</label>
                                    <input name="Doses[@i].IntervalInMonths" value="@dose.IntervalInMonths" type="number" class="form-control" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-check-label">Bắt buộc</label>
                                    <div class="form-check">
                                        <input type="checkbox" name="Doses[@i].IsRequired" value="true" @(dose.IsRequired ? "checked" : "") class="form-check-input" />
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-12">
                                    <label class="form-label">Ghi chú</label>
                                    <textarea name="Doses[@i].Notes" class="form-control">@dose.Notes</textarea>
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-danger mt-2 remove-dose-edit">Xóa liều</button>
                        </div>
                    }
                }
            </div>
            <button type="button" id="add-dose-edit" class="btn btn-sm btn-success">Thêm liều</button>
        </div>
    </div>

    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>Hủy
        </button>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-2"></i>Cập nhật
        </button>
    </div>
</form>

<script>
    // Initialize edit form when modal is shown
    $(document).ready(function() {
        initializeEditVaccineForm();
    });

    function initializeEditVaccineForm() {
        let doseIndexEdit = $('#doses-container-edit .dose-item').length;

        // Add dose handler for edit form
        $('#add-dose-edit').off('click').on('click', function() {
            const container = document.getElementById('doses-container-edit');
            const newDose = document.createElement('div');
            newDose.classList.add('dose-item', 'border', 'rounded', 'p-3', 'mb-3');
            newDose.innerHTML = `
                <input type="hidden" name="Doses.Index" value="${doseIndexEdit}" />
                <input type="hidden" name="Doses[${doseIndexEdit}].Id" value="0" />
                <input type="hidden" name="Doses[${doseIndexEdit}].VaccineId" value="@Model.Id" />
                <div class="row">
                    <div class="col-md-2">
                        <label class="form-label">Mũi số</label>
                        <input type="number" name="Doses[${doseIndexEdit}].DoseNumber" class="form-control" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Tuổi khuyến nghị</label>
                        <input type="text" name="Doses[${doseIndexEdit}].RecommendedAge" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Khoảng cách (tháng)</label>
                        <input type="number" name="Doses[${doseIndexEdit}].IntervalInMonths" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-check-label">Bắt buộc</label>
                        <div class="form-check">
                            <input type="hidden" name="Doses[${doseIndexEdit}].IsRequired" value="false" />
                            <input type="checkbox" name="Doses[${doseIndexEdit}].IsRequired" value="true" checked class="form-check-input" />
                        </div>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-12">
                        <label class="form-label">Ghi chú</label>
                        <textarea name="Doses[${doseIndexEdit}].Notes" class="form-control"></textarea>
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-danger mt-2 remove-dose-edit">Xóa liều</button>
            `;
            container.appendChild(newDose);
            doseIndexEdit++;
        });

        // Remove dose handler for edit form
        $(document).off('click', '.remove-dose-edit').on('click', '.remove-dose-edit', function() {
            $(this).closest('.dose-item').remove();
            reindexDosesEdit();
        });

        function reindexDosesEdit() {
            const container = document.getElementById('doses-container-edit');
            const doseItems = container.querySelectorAll('.dose-item');
            doseIndexEdit = 0;
            doseItems.forEach(item => {
                item.querySelector('input[name$=".Index"]').value = doseIndexEdit;
                item.querySelectorAll('input, select, textarea').forEach(input => {
                    const name = input.name;
                    if (name && name.includes('Doses[')) {
                        input.name = name.replace(/Doses\[\d+\]/, `Doses[${doseIndexEdit}]`);
                    }
                });
                doseIndexEdit++;
            });
        }
    }
</script>